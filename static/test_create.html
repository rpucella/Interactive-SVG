
<form action="/edit_svg" id="main_form" method="post" enctype="multipart/form-data">
    <textarea id="code" name="json_code" placeholder="JSON description" cols="100" rows="40">
    {
	"width":400, 
	"title":"My Awesome Title!",
	"data":[
	    {"label":"First", "value":75},
	    {"label":"Second", "value":50},
	    {"label":"Third", "value":25},
	    {"label":"Fourth", "value":10}
	]
    }
</textarea>
  <input id="svg_code" type="hidden" name="file" value="">
  <input id="flag" type="hidden" name="source" value="chart">
</form>

<button id="compile">Create Interactive SVG</button>

<script>

document.getElementById("compile").addEventListener("click",compile);


function compile () {

    try {
	var json = JSON.parse(document.getElementById("code").value);
    }
    catch (e) {
	alert("Cannot parse JSON description\n"+e.message);
	return;
    }
    
    console.log("JSON = ",json);

    
    var width = json.width || 500;

    var height = 100;
    var top = 0;

    var rHeight = 50;

    var body = ""

    if (json.title) {
	
	body += '<text id="title" text-anchor="middle" x="{}" y="50" dy="0.35em">{}</text>'.format(width/2,json.title);
	height += 100;
	top += 100;
    }

    var data = json.data || [];
    console.log(data);

    var maxValue = Math.max.apply(null,data.map(function(r) { return r.value; }));
    var availWidth = width - 70;   // 20 left margin, 20 right margin, 30 for text?

    var instructions = ""

    var dim_all_but = function(j) { 
	var result = "dim ";
	data.forEach(function(r,i) { if (i !== j) { result += ' group_{}'.format(i); } });
	return result;
    }

    data.forEach(function (r,i) {

	var barWidth = availWidth * (r.value / maxValue);
	
	body += '<g id="group_{}">'.format(i);
	body += '<text id="label_{}" x="20" y="{}" dy="0.35em" text-anchor="start">{}</text>'.format(i,top+i*rHeight+rHeight/4,r.label)
	body += '<rect id="bar_{}" x="20" y="{}" height="{}" width="{}" fill="#467f1a" />'.format(i,top+i*rHeight+rHeight/2,rHeight/2,barWidth);
	body += '<rect id="bar_highlight_{}" display="none" x="19" y="{}" height="{}" width="{}" fill="none" stroke="#003300" stroke-width="2px" />'.format(i,top+i*rHeight+rHeight/2-1,rHeight/2+2,barWidth+2);
	body += '<text id="number_{}" x="{}" y="{}" dy="0.35em" text-anchor="start">{}</text>'.format(i,30+barWidth,top+i*rHeight+3*rHeight/4,r.value);
	body += '</g>';
	height += rHeight;

	instructions += 'hover bar_{} -> {} -> show bar_highlight_{}.\n'.format(i,dim_all_but(i),i);

    });

    body += '<rect id="border" x="0" y="0" width="{}" height="{}" fill="none" stroke="#dddddd" />'.format(width,height);
    
    result_svg = '<svg x=\"0\" y=\"0\" width=\"{}\" height=\"{}\" viewBox="0 0 {} {}">{}</svg>'.format(width,height,width,height,body);

    result_svg += '\n<!--FANTOMAS\n{}\n-->'.format(instructions);

    /* put resulting SVG into the form and submit */
    document.getElementById("svg_code").value = result_svg;
    document.getElementById("main_form").submit();
}


(function(){

    function format () {
	var i = 0, args = arguments;
	return this.replace(/{}/g, function () {
	    return typeof args[i] != 'undefined' ? args[i++] : '';
	});
    }

    if (!String.format) {
	String.prototype.format = format
    }
})();

  
</script>
